---
- name: Install snapd
  become: true
  ansible.builtin.apt:
    name: snapd
    state: present

- name: Install Microk8s
  become: true
  community.general.snap:
    name: microk8s
    classic: true
    channel: "{{ microk8s_version }}"

- name: Add current user to group 'microk8s'
  become: true
  ansible.builtin.user:
    name: "{{ ansible_user }}"
    group: microk8s

- name: Recursively change ownership of ~/.kube
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.kube"
    state: directory
    recurse: yes
    owner: "{{ ansible_user }}"

- name: Add kubectl alias
  ansible.builtin.lineinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    line: "alias kubectl='microk8s kubectl'"
